<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta http-equiv="X-UA-Compatible" content="IE=edge;chrome=1" />
    <title>Silmar.dll - Middleman deploy via Git from Docker</title>
    <link href="http://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
    <link href="/stylesheets/all.css" rel="stylesheet" />
    <link href="/stylesheets/syntax.css" rel="stylesheet" />
    <script src="/javascripts/all.js"></script>
    <link href="/images/favicon.png" rel="shortcut icon" type="image/png" />
  </head>
  <body>
    <nav class="navbar navbar-expand-xl navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="/">
      <img src="/images/author/luis.png" width="45" height="45" class="d-inline-block rounded-circle" alt="Luis Silva">
      &nbsp;<small>I'm a programmer </small><span class="font-weight-bold text-success">\(¬_¬)/</span>
    </a>
    <button class="navbar-toggler bg-success" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <div class="navbar-nav">
        <a class="nav-item nav-link text-success" href="https://stackoverflow.com/users/7935188/luis-silva">
          Stack Overflow
        </a>
        <a class="nav-item nav-link text-success pb-3" href="https://github.com/lesm">
          GitHub
        </a>
        <div class="text-white">
          <div class="d-flex justify-content-between pb-2">
            <h5 class="">Artículos Recientes</h5>
            <button class="navbar-toggler bg-success" type="button" data-toggle="collapse" data-target="#navbarNav2" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
              <i class="fas fa-caret-down"></i>
            </button>
          </div>
          <div class="collapse navbar-collapse" id="navbarNav2">
            <div class="navbar-nav">
                <ul class="list-unstyled">
                  <li>
                    <ol class="list-unstyled">
                        <li class="m-1">
                          <a href="/2021/08/19/middleman-deploy-via-git-from-docker.html" class="nav-item">Middleman deploy via Git from Docker</a>
                          <span>Aug 19</span>
                        </li>
                        <li class="m-1">
                          <a href="/2016/01/11/instalar-y-personalizar-tmux.html" class="nav-item">Instalar y personalizar tmux</a>
                          <span>Jan 11</span>
                        </li>
                        <li class="m-1">
                          <a href="/2016/01/08/instalar-ruby-con-rvm.html" class="nav-item">Instalar ruby con rvm</a>
                          <span>Jan  8</span>
                        </li>
                        <li class="m-1">
                          <a href="/2016/01/08/instalar-nodejs-con-nvm.html" class="nav-item">Instalar nodejs con nvm</a>
                          <span>Jan  8</span>
                        </li>
                        <li class="m-1">
                          <a href="/2016/01/07/instalar-y-personalizar-conky.html" class="nav-item">Instalar y personalizar conky</a>
                          <span>Jan  7</span>
                        </li>
                        <li class="m-1">
                          <a href="/2016/01/07/reiniciar-entorno-grafico-xorg-ctrl-alt-backspace.html" class="nav-item">Reiniciar entorno gráfico Xorg, ctrl + alt + backSpace</a>
                          <span>Jan  7</span>
                        </li>
                        <li class="m-1">
                          <a href="/2016/01/06/activar-touchpad-circular.html" class="nav-item">Activar touchpad circular</a>
                          <span>Jan  6</span>
                        </li>
                        <li class="m-1">
                          <a href="/2015/12/28/instalar-zsh-con-oh-my-zsh.html" class="nav-item">Instalar zsh con oh-my-zsh</a>
                          <span>Dec 28</span>
                        </li>
                        <li class="m-1">
                          <a href="/2015/10/25/creando-alias-en-git.html" class="nav-item">Creando alias en git</a>
                          <span>Oct 25</span>
                        </li>
                    </ol>
                  </li>
                </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</nav>

    <div class="container-fluid">
      <div class="row vh-100">
        <div class="col-xl-3 bg-primary">
          <aside class="container sticky-top">
  <div class="d-flex flex-column align-items-center pb-4">
    <img src="/images/author/luis.png" width="110" height="110" class="rounded-circle m-3" alt="Luis Silva">
    <a class="mb-3" href="/">
      <h5>I'm a programmer \(¬_¬)/</h5>
    </a>
    <div class="d-inline-flex">
      <a class="" href="https://stackoverflow.com/users/7935188/luis-silva">
        <h6>Stack Overflow</h6>
      </a>
      <p class="text-white font-weight-bold"> &nbsp;|&nbsp; </p>
      <a class="" href="https://github.com/lesm">
        <h6>GitHub</h6>
      </a>
    </div>
  </div>

  <div class="text-white">
    <h4 class="text-center pb-4">Artículos Recientes</h4>
    <ul class="list-unstyled">
      <li>
        <ol class="list-unstyled">
            <li class="p-1">
              <span>Aug 19</span>
              <a href="/2021/08/19/middleman-deploy-via-git-from-docker.html">Middleman deploy via Git from Docker</a>
            </li>
            <li class="p-1">
              <span>Jan 11</span>
              <a href="/2016/01/11/instalar-y-personalizar-tmux.html">Instalar y personalizar tmux</a>
            </li>
            <li class="p-1">
              <span>Jan  8</span>
              <a href="/2016/01/08/instalar-ruby-con-rvm.html">Instalar ruby con rvm</a>
            </li>
            <li class="p-1">
              <span>Jan  8</span>
              <a href="/2016/01/08/instalar-nodejs-con-nvm.html">Instalar nodejs con nvm</a>
            </li>
            <li class="p-1">
              <span>Jan  7</span>
              <a href="/2016/01/07/instalar-y-personalizar-conky.html">Instalar y personalizar conky</a>
            </li>
            <li class="p-1">
              <span>Jan  7</span>
              <a href="/2016/01/07/reiniciar-entorno-grafico-xorg-ctrl-alt-backspace.html">Reiniciar entorno gráfico Xorg, ctrl + alt + backSpace</a>
            </li>
            <li class="p-1">
              <span>Jan  6</span>
              <a href="/2016/01/06/activar-touchpad-circular.html">Activar touchpad circular</a>
            </li>
            <li class="p-1">
              <span>Dec 28</span>
              <a href="/2015/12/28/instalar-zsh-con-oh-my-zsh.html">Instalar zsh con oh-my-zsh</a>
            </li>
            <li class="p-1">
              <span>Oct 25</span>
              <a href="/2015/10/25/creando-alias-en-git.html">Creando alias en git</a>
            </li>
        </ol>
      </li>
    </ul>
  </div>
</aside>

        </div>
        <div class="col-xl-9 bg-light">
              <article class="d-flex justify-content-center pt-4">
    <div class="col-md-10" role="main">
      <h2>
        Middleman deploy via Git from Docker<br>
        <h5><time>Aug 19 2021</time></h5>
      </h2>
      <p>This blog was built with <a href="https://middlemanapp.com/">Middleman</a> and deploy to <a href="https://pages.github.com/">GitHub Pages</a>.</p>

<p>I&rsquo;m using the <a href="https://github.com/karlfreeman/middleman-deploy">middleman-deploy</a> gem to deploy via Git.</p>

<p>Last year I decided to use docker to develop and running this blog and one of the problems I had at that moment it was to make 
the deploy works from the docker container.</p>

<p>And that&rsquo;s what this post is about.</p>

<p>I&rsquo;m using <code>ruby:2.7.1-alpine3.12</code> as docker base image.</p>

<p>Before I added docker to this project the dependencies were installed locally and since I have Git already setup it was enough to run the <code>middleman deploy</code> command from the root of the project to deploy to GitHub Pages.</p>

<p>It worked because the <code>middleman-deploy</code> gem had access to these two files:</p>
<div class="highlight"><pre class="highlight plaintext"><code>  ~/.gitconfig
  ~/.ssh/id_rsa
</code></pre></div>
<p>But now all the dependencies live inside of the docker container so we need to setup Git inside of the container.</p>

<p>The <code>middleman-deploy</code> gem makes automatics commits in the deploy process and the commits are make with the user that is in the <code>~/.gitconfig</code> file.</p>

<p>To deploy, the <code>middleman-deploy</code> gem pushes the files generates in the build process to GitHub and it uses the <code>~/.ssh/id_rsa</code> file to authenticate over SSH.</p>

<p>We need to ensure that the Docker container has access to the two files mentioned above.</p>

<p>We&rsquo;ll use <a href="https://docs.docker.com/compose/">docker-compose</a> to make easier our setup.</p>

<p>Docker implements secrets to manage sensitive data like our ssh key.
<em>Docker can read secrets either from its own database (e.g. secrets made with <code>docker secret create</code>) or from a file</em>.</p>

<p>For the <code>~/.gitconfig</code> file we&rsquo;re going to stored it as a volume and for the <code>~/.ssh/id_rsa</code> file we&rsquo;ll use secrets.</p>

<p>docker-compose.yml</p>
<div class="highlight"><pre class="highlight shell"><code>version: <span class="s2">"3.7"</span>

services:
  web:
    build: <span class="nb">.</span>
    volumes:
      - .:/usr/src/app
      - ~/.gitconfig:/root/.gitconfig <span class="c"># Include our .gitconfig file into the container</span>

secrets:
  host_ssh_key: <span class="c"># The name to identify the secret</span>
    file: ~/.ssh/id_rsa <span class="c"># The file to create as secret</span>
</code></pre></div>
<p>The location of the mount point within the container is <code>/run/secrets/&lt;secret_name&gt;</code> 
but we know that the <code>id_rsa</code> file must be inside of the <code>~/.ssh</code> directory.</p>

<p>So the last step is update the Dockerfile to create the <code>~/.ssh</code> directory and make a symbolic link for the <code>id_rsa</code> file.</p>

<p>Docker</p>
<div class="highlight"><pre class="highlight shell"><code>RUN <span class="nb">mkdir</span> ~/.ssh <span class="o">&amp;&amp;</span> <span class="nb">ln</span> <span class="nt">-s</span> /run/secrets/host_ssh_key ~/.ssh/id_rsa
</code></pre></div>
<p>With everything setup we can now deploy to GitHub Pages from a Docker container.</p>
<div class="highlight"><pre class="highlight shell"><code>  <span class="c"># Generate the docker image</span>
  docker-compose build

  <span class="c"># Start the web service</span>
  docker-compose up <span class="nt">-d</span>

  <span class="c"># Deploy from Docker container</span>
  docker-compose <span class="nb">exec </span>web middleman deploy
</code></pre></div>
<p><strong>Dockerfile:</strong></p>
<div class="highlight"><pre class="highlight shell"><code>FROM ruby:2.7.1-alpine3.12

RUN apk add <span class="nt">--update</span> <span class="nt">--no-cache</span> <span class="se">\</span>
  build-base <span class="se">\</span>
  tzdata <span class="se">\</span>
  git <span class="se">\</span>
  openssh <span class="se">\</span>
  yarn

RUN <span class="nb">mkdir</span> ~/.ssh <span class="o">&amp;&amp;</span> <span class="nb">ln</span> <span class="nt">-s</span> /run/secrets/host_ssh_key ~/.ssh/id_rsa

WORKDIR ./usr/src/app

COPY Gemfile<span class="k">*</span> ./

RUN bundle <span class="nb">install

</span>COPY yarn<span class="k">*</span> ./

RUN yarn <span class="nb">install

</span>COPY <span class="nb">.</span> <span class="nb">.</span>

EXPOSE 4567

CMD <span class="o">[</span><span class="s2">"bundle"</span>, <span class="s2">"exec"</span>, <span class="s2">"middleman"</span>, <span class="s2">"s"</span>, <span class="s2">"--bind-address"</span>, <span class="s2">"0.0.0.0"</span><span class="o">]</span>
</code></pre></div>
<p><strong>docker-compose.yml:</strong></p>
<div class="highlight"><pre class="highlight shell"><code>version: <span class="s2">"3.7"</span>

services:
  web:
    build: <span class="nb">.</span>
    volumes:
      - .:/usr/src/app
      - ~/.gitconfig:/root/.gitconfig
    ports:
      - 4567:4567
    secrets:
      - host_ssh_key

secrets:
  host_ssh_key:
    file: ~/.ssh/id_rsa
</code></pre></div>
      <div id='disqus_thread'></div>
<script type='text/javascript'>
//<![CDATA[
                  var disqus_shortname = 'silmardll';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script>
<noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a></noscript>
<a href='http://disqus.com' class='dsq-brlink'>comments powered by <span class='logo-disqus'>Disqus</span></a>

    </div>
  </article>

        </div>
      </div>
      <div class="row">
        <footer class="footer fixed-bottom bg-success pt-3">
  <p class="text-center">Copyright &copy; Luis Silva 2015-2020</p>
</footer>

      </div>
    </div>
  </body>
</html>
